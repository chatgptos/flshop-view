(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/notice/chat"],{"2ee9":function(t,e,i){"use strict";i.r(e);var s=i("e201"),o=i.n(s);for(var n in s)"default"!==n&&function(t){i.d(e,t,(function(){return s[t]}))}(n);e["default"]=o.a},"596d":function(t,e,i){},"5a15":function(t,e,i){"use strict";var s=i("596d"),o=i.n(s);o.a},8858:function(t,e,i){"use strict";(function(t){i("e954");s(i("66fd"));var e=s(i("e26f"));function s(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=i,t(e.default)}).call(this,i("543d")["createPage"])},"88db":function(t,e,i){"use strict";var s;i.d(e,"b",(function(){return o})),i.d(e,"c",(function(){return n})),i.d(e,"a",(function(){return s}));var o=function(){var t=this,e=t.$createElement,i=(t._self._c,t.__map(t.msgList,(function(e,i){var s=t.__get_orig(e),o="chat"==e.type&&e.to_id==t.to_id&&"goods"==e.message.type?t.$flbooth.oss(e.message.content.image,100,0):null,n="chat"==e.type&&e.to_id==t.to_id&&"order"==e.message.type?t.__map(e.message.content.goods,(function(e,i){var s=t.__get_orig(e),o=t.$flbooth.oss(e.image,50,50);return{$orig:s,g1:o}})):null,a="chat"==e.type&&e.to_id==t.to_id?t.$flbooth.oss(e.form.avatar,100,100):null,r="chat"==e.type&&e.to_id==t.to_id?t.$flbooth.timeToChat(e.created):null,c="chat"==e.type&&e.to_id!=t.to_id?t.$flbooth.oss(e.form.avatar,100,100):null,h="chat"==e.type&&e.to_id!=t.to_id?t.$flbooth.timeToChat(e.created):null;return{$orig:s,g0:o,l0:n,g2:a,g3:r,g4:c,g5:h}}))),s=t.goods&&t.isGoods?t.$flbooth.oss(t.goods.image,100,100):null,o=t.__map(t.goodsData,(function(e,i){var s=t.__get_orig(e),o=null!==e.goods?t.$flbooth.oss(e.goods.image,100,100):null;return{$orig:s,g7:o}})),n=t.__map(t.orderData,(function(e,i){var s=t.__get_orig(e),o=t.__map(e.goods,(function(e,i){var s=t.__get_orig(e),o=t.$flbooth.oss(e.image,100,100);return{$orig:s,g8:o}}));return{$orig:s,l3:o}}));t.$mp.data=Object.assign({},{$root:{l1:i,g6:s,l2:o,l4:n}})},n=[]},e201:function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;i("26cb");var s=i("5993"),o={data:function(){return{user_id:this.$store.state.user.id,avatar:this.$store.state.user.avatar,username:this.$store.state.user.username,nickname:this.$store.state.user.nickname,to_id:0,shop_id:0,shop_name:null,shop_avatar:null,textMsg:"",isHistoryLoading:!1,reload:!1,current_page:1,scrollAnimation:!1,scrollTop:0,scrollToView:"",msgList:[],msgImgList:[],goods:null,isGoods:!0,goodsData:[],orderData:[],emptybottom:!1,RECORDER:t.getRecorderManager(),isVoice:!1,voiceTis:"按住 说话",recordTis:"手指上滑 取消发送",recording:!1,willStop:!1,initPoint:{identifier:0,Y:0},recordTimer:null,recordLength:0,AUDIO:t.createInnerAudioContext(),playMsgid:null,VoiceTimer:null,popupLayerClass:!1,hideMore:!0,modalName:null,stateText:["等待您付款","付款成功","待收货","待评论","退款订单","订单已完成","交易关闭"],refundStatusText:["未退款","退款中","待退货","退款完成","退款关闭","退款被拒"],refundStatusBg:["","bg-orange","bg-red","bg-green","bg-grey","bg-red"],TabCur:"默认",hideEmoji:!0,emojiList:this.emojiData(),QnUrl:"",Sysmodel:this.$flbooth.wanlsys().model}},onLoad:function(e){var i=this;e.hasOwnProperty("goods")&&(this.goods=JSON.parse(e.goods),setTimeout((function(){i.isGoods=!1}),5e3)),this.$store.commit("chat/setIschat",{notice:!1}),this.$api.post({url:"/flbooth/chat/getShopChat",data:{id:e.shop_id,type:"chat"},success:function(t){i.to_id=t.user_id,i.shop_id=t.id,i.shop_name=t.shopname,i.shop_avatar=t.avatar,i.$flbooth.title(t.shopname+(1==t.isOnline?"-在线":"-离线")),i.getMsgList(t.user_id)}}),this.AUDIO.onEnded((function(t){i.playMsgid=null})),this.RECORDER.onStart((function(t){i.recordBegin(t)})),this.RECORDER.onStop((function(t){i.recordEnd(t)})),t.$on("onChat",this.onSend)},onNavigationBarButtonTap:function(){this.onShop(this.shop_id)},onUnload:function(){this.$store.dispatch("chat/update",{type:"del",id:this.to_id}),this.$store.commit("chat/setIschat",{notice:!0,number:0})},onShow:function(){this.scrollTop=9999999},methods:{getMsgList:function(e){var i=this;t.getStorage({key:"wanlchat:message_"+e,success:function(t){for(var e=t.data,s=0;s<e.length;s++)"chat"==e[s].type&&"img"==e[s].message.type&&(e[s].message.content=i.setPicSize(e[s].message.content),i.msgImgList.push(e[s].message.content.url)),"chat"==e[s].type&&"text"==e[s].message.type&&(e[s].message.content.text=i.replaceEmoji(e[s].message.content.text));i.msgList=e,i.$nextTick((function(){i.scrollTop=9999,i.$nextTick((function(){i.scrollAnimation=!0}))}))}})},onChat:function(t){var e=this;"system"==t.type?"text"==t.msg.type&&this.addSystemTextMsg(t):"chat"==t.type&&("text"==t.message.type&&this.addTextMsg(t),"voice"==t.message.type&&this.addVoiceMsg(t),"img"==t.message.type&&this.addImgMsg(t),"goods"==t.message.type&&this.addGoodsMsg(t),"order"==t.message.type&&this.addOrderMsg(t)),this.$nextTick((function(){e.scrollToView="msg"+t.id}))},onSend:function(t){var e=this;t.form.id==this.to_id&&("system"==t.type?"text"==t.msg.type&&this.addSystemTextMsg(t):"chat"==t.type&&("text"==t.message.type&&this.addTextMsg(t),"voice"==t.message.type&&this.addVoiceMsg(t),"img"==t.message.type&&this.addImgMsg(t),"goods"==t.message.type&&this.addGoodsMsg(t),"order"==t.message.type&&this.addOrderMsg(t)),this.$nextTick((function(){e.scrollToView="msg"+t.id})))},sendMsg:function(t,e){var i=1;this.msgList.length&&(i=this.msgList[this.msgList.length-1].id,i++);var s={id:i,type:"chat",to_id:this.to_id,form:{id:this.user_id,avatar:this.avatar,name:this.nickname},message:{type:e,content:t},created:parseInt((new Date).getTime()/1e3)};this.onChat(JSON.parse(JSON.stringify(s))),this.$store.dispatch("chat/update",{type:"send",data:s,shop:{id:this.shop_id,user_id:this.to_id,name:this.shop_name,avatar:this.shop_avatar}}),this.$flbooth.send(s)},addTextMsg:function(t){t.message.content.text=this.replaceEmoji(t.message.content.text),this.msgList.push(t)},addVoiceMsg:function(t){this.msgList.push(t)},addImgMsg:function(t){t.message.content=this.setPicSize(t.message.content),this.msgImgList.push(t.message.content.url),this.msgList.push(t)},addGoodsMsg:function(t){this.msgList.push(t)},addOrderMsg:function(t){this.msgList.push(t)},addSystemTextMsg:function(t){this.msgList.push(t)},emojiData:function(){var t={},e=[],i={};return s.forEach((function(s){var o=s.category.length>0?s.category:"默认";t[o]||(t[o]=[],e.push(o)),t[o].push(s),i[s.phrase]=s.icon})),{groups:t,categories:e,map:i}},replaceEmoji:function(t){var e=this,i=t.replace(/\[([^(\]|\[)]*)\]/g,(function(t,i){return'<img src="'+e.emojiList.map[t]+'" width="18rpx">'}));return i.replace(/(\r\n)|(\n)/g,"<br>")},tabSelect:function(t){this.TabCur=t.currentTarget.dataset.id},loadHistory:function(t){var e=this;if(!this.isHistoryLoading&&!this.reload){this.isHistoryLoading=!0,this.scrollAnimation=!1;var i=this.msgList[0].id;this.$api.post({url:"/flbooth/chat/history",data:{to_id:this.to_id,page:this.current_page},success:function(t){for(var s=t.data,o=0;o<s.length;o++)"chat"==s[o].type&&"img"==s[o].message.type&&(s[o].message.content=e.setPicSize(s[o].message.content),e.msgImgList.unshift(s[o].message.content.url)),"chat"==s[o].type&&"text"==s[o].message.type&&(s[o].message.content.text=e.replaceEmoji(s[o].message.content.text));s.sort((function(t,e){return t.modified-e.modified})),e.msgList=1==t.current_page?s:s.concat(e.msgList),e.$nextTick((function(){e.scrollToView="msg"+i,e.$nextTick((function(){e.scrollAnimation=!0}))})),t.current_page==t.last_page?e.reload=!0:e.current_page=t.current_page+1,e.isHistoryLoading=!1},fail:function(t){e.isHistoryLoading=!1}})}},setPicSize:function(e){var i=t.upx2px(350),s=t.upx2px(350);if(e.w>i||e.h>s){var o=e.w/e.h;e.w=o>1?i:s*o,e.h=o>1?i/o:s}return e},showMore:function(){this.isVoice=!1,this.hideEmoji=!0,this.hideMore?(this.hideMore=!1,this.openDrawer()):this.hideDrawer()},openDrawer:function(){this.emptybottom=!0,this.popupLayerClass=!0},hideDrawer:function(){var t=this;this.emptybottom=!1,this.popupLayerClass=!1,setTimeout((function(){t.hideMore=!0,t.hideEmoji=!0}),150)},chooseImage:function(){this.getImage("album")},camera:function(){this.getImage("camera")},getImage:function(e){var i=this;this.hideDrawer(),t.chooseImage({sourceType:[e],sizeType:["original","compressed"],success:function(e){i.$api.get({url:"/flbooth/common/uploadData",success:function(s){for(var o=0;o<e.tempFilePaths.length;o++)t.getImageInfo({src:e.tempFilePaths[o],success:function(t){i.$api.upload({url:s.uploadurl,filePath:t.path,name:"file",formData:"local"==s.storage?null:s.multipart,success:function(e){i.sendMsg({url:e.fullurl,w:t.width,h:t.height},"img")}})}})}})}})},showPic:function(e){t.previewImage({indicator:"none",current:e.content.url,urls:this.msgImgList})},chooseEmoji:function(){this.hideMore=!0,this.hideEmoji?(this.hideEmoji=!1,this.openDrawer()):this.hideDrawer()},addEmoji:function(t){this.textMsg+=t},textareaFocus:function(){this.emptybottom=!0,this.closeTips(),this.popupLayerClass&&0==this.hideMore&&this.hideDrawer()},textareaBlur:function(){this.emptybottom=!1},sendText:function(){if(this.hideDrawer(),this.textMsg){var t={text:this.textMsg};this.sendMsg(t,"text"),this.textMsg=""}},sendGoods:function(t){this.sendMsg(t,"goods"),this.closeTips(),this.hideModal()},sendOrder:function(t){this.sendMsg({id:t.id,order_no:t.order_no,goods:t.goods,state:t.state},"order"),this.closeTips(),this.hideModal()},closeTips:function(){this.isGoods=!1},complaint:function(){this.$flbooth.to("/pages/user/complaint/complaint?id=".concat(this.shop_id,"&type=2")),this.hideDrawer()},browsing:function(){var t=this;this.hideDrawer(),this.$api.post({url:"/flbooth/product/getBrowsingToShop",data:{shop_id:this.shop_id},success:function(e){t.goodsData=e,t.modalName="goods"}})},order:function(){var t=this;this.hideDrawer(),this.$api.post({url:"/flbooth/order/getOrderListToShop",data:{shop_id:this.shop_id},success:function(e){t.orderData=e,t.modalName="order"}})},hideModal:function(){this.modalName=null},playVoice:function(t){var e=this;this.playMsgid=t.id,this.AUDIO.src=t.content.url,this.$nextTick((function(){e.AUDIO.play()}))},voiceBegin:function(t){t.touches.length>1||(this.initPoint.Y=t.touches[0].clientY,this.initPoint.identifier=t.touches[0].identifier,this.RECORDER.start({format:"mp3"}))},recordBegin:function(t){var e=this;this.recording=!0,this.voiceTis="松开 结束",this.recordLength=0,this.recordTimer=setInterval((function(){e.recordLength++}),1e3)},voiceCancel:function(){this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",this.willStop=!0,this.RECORDER.stop()},voiceIng:function(e){if(this.recording){var i=e.touches[0];this.initPoint.Y-i.clientY>=t.upx2px(200)?(this.willStop=!0,this.recordTis="松开手指 取消发送"):(this.willStop=!1,this.recordTis="手指上滑 取消发送")}},voiceEnd:function(t){this.recording&&(this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",this.RECORDER.stop())},recordEnd:function(t){var e=this;clearInterval(this.recordTimer),this.willStop?console.log("取消发送录音"):this.$api.get({url:"/flbooth/common/uploadData",success:function(i){e.$api.upload({url:i.uploadurl,filePath:t.tempFilePath,name:"file",formData:"local"==i.storage?null:i.multipart,success:function(t){var i={length:0,url:t.fullurl};i.length=e.recordLength%60,i.length>0&&e.sendMsg(i,"voice")},fail:function(t){e.$flbooth.msg(JSON.parse(t.data).msg)}})}}),this.willStop=!1},switchVoice:function(){this.hideDrawer(),this.isVoice=!this.isVoice},discard:function(){}}};e.default=o}).call(this,i("543d")["default"])},e26f:function(t,e,i){"use strict";i.r(e);var s=i("88db"),o=i("2ee9");for(var n in o)"default"!==n&&function(t){i.d(e,t,(function(){return o[t]}))}(n);i("5a15");var a,r=i("f0c5"),c=Object(r["a"])(o["default"],s["b"],s["c"],!1,null,null,null,!1,s["a"],a);e["default"]=c.exports}},[["8858","common/runtime","common/vendor"]]]);